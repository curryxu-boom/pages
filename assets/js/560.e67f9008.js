(window.webpackJsonp=window.webpackJsonp||[]).push([[560],{1410:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"一、故障说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、故障说明"}},[s._v("#")]),s._v(" 一、故障说明")]),s._v(" "),t("p",[s._v("今天早上系统突然崩了，访问不了。发现日志中报出了大量的异常"),t("code",[s._v("Too many open files")]),s._v("。根据经验判断应该是操作了大量的IO并且在操作后，没有关闭IO流。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("org.apache.tomcat.util.net.Acceptor: Socket accept failed\njava.io.IOException: Too many open files\n        at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method) ~[na:1.8.0_121]\n        at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:422) ~[na:1.8.0_12\n1]\n        at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:250) ~[na:1.8.0_12\n1]\n        at org.apache.tomcat.util.net.NioEndpoint.serverSocketAccept(NioEndpoint.java:463) ~[tomcat-\nembed-core-9.0.21.jar!/:9.0.21]\n        at org.apache.tomcat.util.net.NioEndpoint.serverSocketAccept(NioEndpoint.java:73) ~[tomcat-e\nmbed-core-9.0.21.jar!/:9.0.21]\n        at org.apache.tomcat.util.net.Acceptor.run(Acceptor.java:95) ~[tomcat-embed-core-9.0.21.jar!\n/:9.0.21]\n        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_121]\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h2",{attrs:{id:"二、too-many-open-files描述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、too-many-open-files描述"}},[s._v("#")]),s._v(" 二、too many open files描述")]),s._v(" "),t("ul",[t("li",[s._v("too many open files是Linux系统中常见的错误，从字面意思上看就是说程序打开的文件数过多，不过这里的files不单是文件的意思，也包括打开的通讯链接(比如socket)，正在监听的端口等等，所以有时候也可以叫做句柄(handle)，这个错误通常也可以叫做句柄数超出系统限制。")]),s._v(" "),t("li",[s._v("因为在linux系统设计里面遵循一切都是文件的原则，即磁盘文件、目录、网络套接字、磁盘、管道等，所有这些都是文件，在我们进行打开的时候会返回一个"),t("code",[s._v("fd")]),s._v("，即是文件句柄。如果频繁的打开文件，或者打开网络套接字而忘记释放就会有句柄泄露的现象。在linux系统中对进程可以调用的文件句柄数进行了限制，在默认情况下每个进程可以调用的最大句柄数是"),t("code",[s._v("1024")]),s._v("个，如果超过了这个限制，进程将无法获取新的句柄，而从导致不能打开新的文件或者网络套接字，对于线上服务器即会出现服务被拒绝的情况")]),s._v(" "),t("li",[s._v("在linux下的fd是有限制的，一个是系统的限制，一个是用户进程限制")])]),s._v(" "),t("h2",{attrs:{id:"三、故障排除"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、故障排除"}},[s._v("#")]),s._v(" 三、故障排除")]),s._v(" "),t("p",[s._v("引起的原因就是进程在某个时刻打开了超过系统限制的文件数量以及通讯链接数，通过命令"),t("code",[s._v("ulimit -a")]),s._v("可以查看当前系统设置的最大句柄数是多少")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@xxx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ulimit -a")]),s._v("\ncore "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndata seg size           "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nscheduling priority             "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size               "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -f"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\npending signals                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256967")]),s._v("\nmax locked memory       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\nmax memory size         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" files                      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v("\npipe size            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v(" bytes, -p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\nPOSIX message queues     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes, -q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("819200")]),s._v("\nreal-time priority              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nstack size              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v("\ncpu "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seconds, -t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nmax user processes              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-u"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256967")]),s._v("\nvirtual memory          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" locks                      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ecs-qrmyy-web gzh_app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsof -p 1864 |wc -l")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[t("strong",[s._v("open files")]),s._v(" 那一行就代表系统目前允许单个进程打开的最大句柄数，这里是 1024")]),s._v(" "),t("p",[s._v("查看 java服务 占据的 pid")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-nlp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" :8081\n\ntcp6     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" :::8102            :::*             LISTEN    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1864")]),s._v("/java \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("p",[t("strong",[s._v("第一次操作lsof命令可能需要安装")]),s._v("："),t("code",[s._v("yum install -y lsof")])])]),s._v(" "),t("p",[s._v("接下来看我这个java服务到底打开了多少文件。此处使用命令："),t("code",[s._v("lsof")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1864")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 返回值：1124")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("此时发现，进程 1864，也就是我们的 java 程序操作了 1124 个文件，并且没有关闭。超过了我们系统允许的数量 1024。")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("如果是普通的虚拟机或者物理，可以通过如下命令，找到打开文件数量最多的进程：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查看了排在前面的几个进程")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("uniq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-nr")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v("\n\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19140")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29785")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17020")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27749")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10918")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20930")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10560")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1864")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9211")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5349")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4880")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10316")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 说明 第一列为 进程打开的文件句柄数 第二列为 PID")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])])]),s._v(" "),t("p",[s._v("重新回到我们刚才的java 程序操作中，我们发现java程序的打开的文件太多了，我们将其操作的文件导出到文件中，在文件中查看。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1864")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" openfile.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在导出的文件中找到打开次数最多的文件，然后在代码中排除即可。")]),s._v(" "),t("p",[s._v("我们的代码中是重复操作了同一个文件，文件名相同，比较好找，如果文件名字不同，可能需要开发人员细心排除一下了")]),s._v(" "),t("h3",{attrs:{id:"原因分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原因分析"}},[s._v("#")]),s._v(" 原因分析")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("1、大多数情况是程序没有正常关闭一些资源引起的，所以出现这种情况，请检查io读写，socket通讯等是否正常关闭")])]),s._v(" "),t("ul",[t("li",[s._v("操作系统的中打开文件的最大句柄数受限所致，"),t("strong",[s._v("常常发生在很多个并发用户访问服务器的时候")]),s._v("。因为为了执行每个用户的应用服务器都要加载很多文件(new一个socket就需要一个文件句柄),这就会导致打开文件的句柄的缺乏")]),s._v(" "),t("li",[s._v("主要方向：在源码项目中查找所有引用了InputStream或者其他流的地方，查看其是否在使用完后，正常close掉，此处建议将流的close放到finally块中，这样异常时也会去close流。")]),s._v(" "),t("li",[s._v("次要方向：session或者其他有用到socket的代码处，仔细查询看是否有没有释放资源的地方")])]),s._v(" "),t("p",[t("strong",[s._v("2、 如果检查程序没有问题，那就有可能是linux默认的open files值太小，不能满足当前程序默认值的要求，比如数据库连接池的个数，tomcat请求连接的个数等")])]),s._v(" "),t("ul",[t("li",[s._v("限制：有时是linux系统的参数的限制，需要修改内核参数。有时是中间件（"),t("a",{attrs:{href:"https://www.cnblogs.com/keen-allan/archive/2012/04/25/2469564.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("weblogic"),t("OutboundLink")],1),s._v("、"),t("a",{attrs:{href:"http://stephen830.iteye.com/blog/2111190",target:"_blank",rel:"noopener noreferrer"}},[s._v("nginx"),t("OutboundLink")],1),s._v("）中启动文件参数限制，尤其是默认1024，在修改linux后若中间件有涉及也要同步修改")])])]),s._v(" "),t("h2",{attrs:{id:"四、其他解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四、其他解决方案"}},[s._v("#")]),s._v(" 四、其他解决方案")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("如果故障原因不是因为文件没有关闭，或者项目需要开启更多句柄，可以修改配置文件，从而允许打开更多文件")])]),s._v(" "),t("li",[t("strong",[s._v("尽量把类打成jar包,因为一个jar包只消耗一个文件句柄,如果不打包,一个类就消耗一个文件句柄.")]),s._v(" "),t("strong",[s._v("java的垃圾回收不能关闭网络连接打开的文件句柄,如果没有执行close()(例如:java.net.Socket.close())则文件句柄将一直存在,而不能被关闭.你也可以考虑设置socket的最大打开数来控制这个问题.")]),s._v(" "),t("strong",[s._v("对操作系统做相关的设置,增加最大文件句柄数量")])])]),s._v(" "),t("h3",{attrs:{id:"_1-临时修改方案-重启失效"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-临时修改方案-重启失效"}},[s._v("#")]),s._v(" 1 临时修改方案，重启失效")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将句柄设置为 102048")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("102048")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_2-永久方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-永久方案"}},[s._v("#")]),s._v(" 2 永久方案")]),s._v(" "),t("p",[s._v("查看"),t("strong",[s._v("系统")]),s._v("允许打开的最大文件数")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/fs/file-max\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("修改 "),t("code",[s._v("limits.conf")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/security/limits.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("文件的最后添加")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("*       soft    nofile  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n*       hard    nofile  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("最终效果：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#<domain>      <type>  <item>         <value>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#*               soft    core            0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#root            hard    core            100000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#*               hard    rss             10000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#@student        hard    nproc           20")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#@faculty        soft    nproc           20")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#@faculty        hard    nproc           50")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ftp             hard    nproc           0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ftp             -       chroot          /ftp")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#@student        -       maxlogins       4")]),s._v("\n \n*       soft    nofile  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n*       hard    nofile  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("最前的 "),t("code",[s._v("*")]),s._v(" 表示所有用户，可根据需要设置某一用户")]),s._v(" "),t("p",[s._v("然后修改全系统总限制")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/sysctl.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在文件底部添加")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("fs.file-max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("655360")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("立即生效")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sysctl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这样就修改完毕了，用户级句柄数的修改需要重启一下才能生效，最好执行一下"),t("code",[s._v("reboot")]),s._v("，再次输入"),t("code",[s._v("ulimit -n")]),s._v("查看已经修改好了")])])}),[],!1,null,null,null);a.default=e.exports}}]);